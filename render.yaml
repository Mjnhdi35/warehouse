services:
  - type: web
    name: warehouse-api
    runtime: node
    plan: free
    rootDir: .
    autoDeploy: false
    envVars:
      - key: NODE_ENV
        value: production
    healthCheckPath: /api
    buildCommand: |
      corepack enable || true &&
      corepack prepare yarn@4.10.3 --activate || true && 
      NODE_OPTIONS="--max-old-space-size=768" yarn install --immutable &&
      NODE_OPTIONS="--max-old-space-size=768" yarn workspace @warehouse/api build
    startCommand: cd apps/api && NODE_OPTIONS="--max-old-space-size=512" node dist/main

  - type: web
    name: warehouse-web
    runtime: node
    plan: free
    rootDir: .
    autoDeploy: false
    envVars:
      - key: NODE_ENV
        value: production
    healthCheckPath: /
    buildCommand: |
      corepack enable || true && 
      corepack prepare yarn@4.10.3 --activate || true && 
      NODE_OPTIONS="--max-old-space-size=768" yarn install --immutable && 
      NODE_OPTIONS="--max-old-space-size=768" yarn workspace @warehouse/web build
    startCommand: yarn workspace @warehouse/web start
