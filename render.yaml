services:
  - type: web
    name: warehouse-api
    runtime: node
    plan: free
    rootDir: .
    autoDeploy: false
    envVars:
      - key: NODE_ENV
        value: production
    healthCheckPath: /api
    buildCommand: |
      corepack enable || true &&
      corepack prepare yarn@4.10.3 --activate || true && 
      NODE_OPTIONS="--max-old-space-size=400" yarn install --immutable &&
      NODE_OPTIONS="--max-old-space-size=400" yarn workspaces focus @warehouse/api --production &&
      rm -rf apps/web node_modules/@warehouse/web 2>/dev/null || true &&
      NODE_OPTIONS="--max-old-space-size=400" yarn workspace @warehouse/api build
    startCommand: cd apps/api && NODE_OPTIONS="--max-old-space-size=350" yarn start:prod

  - type: web
    name: warehouse-web
    runtime: node
    plan: free
    rootDir: .
    autoDeploy: false
    envVars:
      - key: NODE_ENV
        value: production
    healthCheckPath: /
    buildCommand: |
      corepack enable || true && 
      corepack prepare yarn@4.10.3 --activate || true && 
      NODE_OPTIONS="--max-old-space-size=400" yarn install --immutable &&
      NODE_OPTIONS="--max-old-space-size=400" yarn workspaces focus @warehouse/web --production &&
      rm -rf apps/api node_modules/@warehouse/api 2>/dev/null || true &&
      NODE_OPTIONS="--max-old-space-size=400" yarn workspace @warehouse/web build
    startCommand: yarn workspace @warehouse/web start
